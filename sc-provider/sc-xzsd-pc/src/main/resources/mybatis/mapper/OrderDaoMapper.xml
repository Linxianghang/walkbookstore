<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xzsd.pc.order.dao.OrderDao">

    <!--查询订单详情-->
    <select id="getListOrder" parameterType="com.xzsd.pc.order.entity.OrderInfo" resultType="com.xzsd.pc.order.entity.OrderVO">
        select
        t2.client_id userId,
        t1.order_id orderId,
        t1.goods_id goodsId,
        t3.goods_name goodsName,
        t1.goods_count goodsCount,
        t1.the_goods_all_price theGoodsAllPrice,
        t3.goods_price goodsPrice,
        t3.goods_original_cost goodsShelfCost
        from t_info_order_deepen t1
        left join t_info_order t2 on t1.order_id = t2.order_id
        left join t_info_goods t3 on t1.goods_id = t3.goods_id
        where t1.order_id = #{orderId}
        and t1.is_delete = 0
        order by t1.create_time desc
    </select>

    <!--修改订单状态-->
    <update id="updateOrderState" parameterType="com.xzsd.pc.order.entity.OrderInfo">
        update t_info_order
        set
        order_state_id = #{orderStateId},
        update_time = now(),
        update_user   = #{updateUser},
        version = version + 1
        where order_id = #{orderId}
        and version = #{version}
    </update>

    <!--分页查询订单接口-->
    <select id="listOrdersByPage" parameterType="com.xzsd.pc.order.entity.OrderInfo"
            resultType="com.xzsd.pc.order.entity.OrderSearchVO">
        select
        t1.order_id orderId,
        t1.order_all_cost orderAllCost,
        t1.order_state_id orderStateId,
        t1.store_id storeId,
        t2.user_name userName,
        t2.phone phone,
        t1.pay_time payTime,
        t1.version version
        from t_info_order t1, t_sys_user t2
        where t1.client_id = t2.user_id
        and t1.is_delete = 0
        <if test="userName != null and userName != ''">
            and t2.user_name like concat('%', #{userName}, '%')
        </if>
        <if test="orderId != null and orderId != ''">
            and t1.order_id like concat('%', #{orderId}, '%')
        </if>
        <if test="payTimeStart != null and payTimeStart != '' and payTimeEnd == null">
            and t1.pay_time &gt;= #{payTimeStart}
        </if>
        <if test="payTimeStart == null and payTimeEnd != null and payTimeEnd != ''">
            and t1.pay_time &lt;= #{payTimeEnd}
        </if>
        <if test="payTimeStart != null and payTimeStart != '' and payTimeEnd != null and payTimeEnd != ''">
            and t1.pay_time between #{payTimeStart} and #{payTimeEnd}
        </if>
        <if test="phone != null and phone != ''">
            and t2.phone like concat('%', #{phone}, '%')
        </if>
        <if test="orderStateId != null and orderStateId != ''">
            and t1.order_status_id = #{orderStateId}
        </if>
        order by t1.create_time desc
    </select>

</mapper>